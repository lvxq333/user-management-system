<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹³å°æ¦‚è§ˆ | å¹¿åŸŸç«‹ä½“é£é™©æ„ŸçŸ¥å¹³å°</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ›¡ï¸</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* å…¨å±€æ ·å¼é‡ç½®å’Œä¸»é¢˜å®šä¹‰ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', Arial, sans-serif; }
        body { background: linear-gradient(135deg, #0a1e3d, #07162e); color: #e0f0ff; min-height: 100vh; overflow-x: hidden; }

        /* å¤´éƒ¨å¯¼èˆªæ æ ·å¼ */
        .header {
            background: rgba(3, 8, 41, 0.9);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            padding: 15px 30px;
            align-items: center;
            border-bottom: 1px solid #1a3a6e;
            position: sticky; top: 0; z-index: 1000;
        }
        .logo-container { display: flex; align-items: center; }
        .logo-icon { width: 45px; height: 45px; background: linear-gradient(45deg, #00c6ff, #0072ff); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 15px; box-shadow: 0 0 15px rgba(0, 198, 255, 0.5); }
        .logo-icon i { font-size: 24px; color: white; }
        .logo-text h1 { font-size: 22px; letter-spacing: 1px; background: linear-gradient(to right, #fff, #a5c7ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-text p { font-size: 10px; color: #648cbd; text-transform: uppercase; letter-spacing: 2px; }
        .nav-links { display: flex; gap: 25px; }
        .nav-item { color: #8fa9cc; text-decoration: none; font-size: 15px; display: flex; align-items: center; gap: 8px; transition: all 0.3s; cursor: pointer; padding: 5px 10px; border-radius: 5px; }
        .nav-item:hover, .nav-item.active { color: #00c6ff; background: rgba(0, 198, 255, 0.1); }
        .user-profile { display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.05); padding: 5px 15px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); }
        .user-info { text-align: right; }
        .user-name { font-size: 14px; font-weight: bold; color: #fff; }
        .user-role { font-size: 11px; color: #00c6ff; }
        .logout-btn { color: #ff4d4f; cursor: pointer; font-size: 18px; transition: transform 0.2s; }
        .logout-btn:hover { transform: scale(1.1); }

        /* ä¸»ä½“å¸ƒå±€æ ·å¼ */
        .container { display: grid; grid-template-columns: 280px 1fr 320px; gap: 20px; padding: 20px; height: calc(100vh - 80px); }
        .panel { background: rgba(13, 33, 68, 0.6); border: 1px solid rgba(30, 70, 130, 0.5); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; backdrop-filter: blur(10px); }
        .panel-header { padding: 12px 15px; background: rgba(20, 50, 100, 0.4); border-bottom: 1px solid rgba(30, 70, 130, 0.5); display: flex; justify-content: space-between; align-items: center; }
        .panel-title { font-size: 16px; font-weight: bold; color: #00c6ff; display: flex; align-items: center; gap: 10px; }
        .panel-content { flex: 1; padding: 15px; overflow-y: auto; }

        /* --- åœ°å›¾åŒºåŸŸæ ·å¼ä¿®æ”¹ --- */
        .map-area {
            position: relative; /* ä¸ºå†…éƒ¨ç»å¯¹å®šä½å…ƒç´ æä¾›åŸºå‡† */
            background: #07162e;
            border-radius: 12px;
            border: 1px solid rgba(30, 70, 130, 0.5);
            overflow: hidden;
            /* ç§»é™¤åŸæœ‰çš„èƒŒæ™¯å›¾å ä½ç¬¦ */
        }
        /* åœ°å›¾å®¹å™¨ï¼Œå æ»¡æ•´ä¸ªåŒºåŸŸ */
        #beijing-map-container {
            width: 100%;
            height: 100%;
        }
        /* åœ°å›¾ä¸Šçš„æ ‡é¢˜æµ®å±‚ */
        .map-overlay-title {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            color: #00c6ff;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0,198,255,0.5);
            display: flex;
            align-items: center;
            gap: 10px;
            pointer-events: none; /* é˜²æ­¢é®æŒ¡åœ°å›¾æ“ä½œ */
        }

    </style>
</head>
<body>
    <header class="header">
        <div class="logo-container">
            <div class="logo-icon"><i class="fas fa-shield-halved"></i></div>
            <div class="logo-text">
                <h1>å¹¿åŸŸç«‹ä½“é£é™©æ„ŸçŸ¥å¹³å°</h1>
                <p>Intelligent Service Platform</p>
            </div>
        </div>

        <nav class="nav-links">
            <a href="home.html" class="nav-item active"><i class="fas fa-home"></i>å¹³å°æ¦‚è§ˆ</a>
            <a href="#" class="nav-item"><i class="fas fa-map-marked-alt"></i>ç”µå­åœ°å›¾</a>
            <a href="#" class="nav-item"><i class="fas fa-exclamation-triangle"></i>é£é™©é¢„è­¦</a>
            <a id="nav-admin-link" href="ç”¨æˆ·ç®¡ç†æ§åˆ¶å°.html" class="nav-item" style="display: none;">
                <i class="fas fa-users-cog"></i> ç”¨æˆ·ç®¡ç†
            </a>
        </nav>

        <div class="user-profile">
            <div class="user-info">
                <span><i class="fas fa-user-circle"></i> <span id="display-user-name">åŠ è½½ä¸­...</span></span>
                <span id="display-user-role" style="font-size: 12px; color: #8ba4c9; display: block; text-align: right;"></span>
            </div>
            <div class="logout-btn" title="é€€å‡ºç³»ç»Ÿ" onclick="handleLogout()">
                <i class="fas fa-power-off"></i>
            </div>
        </div>
    </header>

    <main class="container">
        <aside class="panel">
            <div class="panel-header">
                <div class="panel-title"><i class="fas fa-chart-pie"></i>ç³»ç»ŸçŠ¶æ€ç›‘æ§</div>
            </div>
            <div class="panel-content">
                <div id="chart-status" style="width: 100%; height: 250px;"></div>
            </div>
        </aside>

        <section class="map-area">
            <div class="map-overlay-title">
                <i class="fas fa-cloud-showers-heavy"></i>
                åŒ—äº¬å¸‚å®æ—¶é™é›¨æ°´ä½ç›‘æµ‹å›¾ (æ¨¡æ‹Ÿæ•°æ®)
            </div>
            <div id="beijing-map-container"></div>
        </section>

        <aside class="panel">
            <div class="panel-header">
                <div class="panel-title"><i class="fas fa-bell"></i>æœ€è¿‘è­¦æŠ¥</div>
            </div>
            <div class="panel-content" style="padding: 10px;">
                 <div style="background: rgba(255, 77, 79, 0.1); border-left: 4px solid #ff4d4f; padding: 12px; margin-bottom: 10px; border-radius: 4px;">
                    <div style="color: #ff4d4f; font-weight: bold; font-size: 14px; margin-bottom: 5px;"><i class="fas fa-triangle-exclamation mr-2"></i> æµ·æ·€åŒºè¥¿åŒ—æ—ºç›‘æµ‹ç‚¹æŠ¥è­¦</div>
                    <div style="font-size: 12px; color: #ff7875;">å½“å‰æ°´ä½å·²è¶…è¿‡è­¦æˆ’çº¿ 15.2mmï¼Œè¯·æ³¨æ„æ’æ¶ã€‚</div>
                    <div style="font-size: 11px; color: #aaa; margin-top: 5px;">2023-10-27 14:30:22</div>
                </div>
                <div style="background: rgba(250, 173, 20, 0.1); border-left: 4px solid #faad14; padding: 12px; margin-bottom: 10px; border-radius: 4px;">
                    <div style="color: #faad14; font-weight: bold; font-size: 14px; margin-bottom: 5px;"><i class="fas fa-circle-exclamation mr-2"></i> æœé˜³åŒºå¤§æœ›è·¯ç§¯æ°´é¢„è­¦</div>
                    <div style="font-size: 12px; color: #ffc069;">é¢„è®¡æœªæ¥ä¸€å°æ—¶é™é›¨å¢å¼ºï¼Œå­˜åœ¨ç§¯æ°´é£é™©ã€‚</div>
                     <div style="font-size: 11px; color: #aaa; margin-top: 5px;">2023-10-27 14:15:10</div>
                </div>
            </div>
        </aside>
    </main>

    <script>
        // -----------------------------------
        // è®¤è¯ä¸æƒé™é€»è¾‘
        // -----------------------------------
        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            const userStr = localStorage.getItem('current_user');

            // ä¸¥æ ¼æ ¡éªŒï¼šå¿…é¡»åŒæ—¶å­˜åœ¨ Token å’Œ ç”¨æˆ·ä¿¡æ¯
            if (!token || !userStr) {
                console.warn('æœªæ£€æµ‹åˆ°ç™»å½•çŠ¶æ€ï¼Œé‡å®šå‘è‡³ç™»å½•é¡µ');
                // æ¸…é™¤å¯èƒ½æ®‹ç•™çš„ä¸å®Œæ•´æ•°æ®
                localStorage.clear();
                window.location.href = 'login.html';
                return;
            }

            try {
                const user = JSON.parse(userStr);
                // æ˜¾ç¤ºç”¨æˆ·å§“å
                document.getElementById('display-user-name').textContent = user.realName || user.username;

                // æƒé™åˆ¤æ–­ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºç®¡ç†å‘˜
                // ä¾æ®ï¼šç”¨æˆ·åä¸º 'admin' æˆ– è§’è‰²åˆ—è¡¨ä¸­åŒ…å« 'Administrator'
                const isAdmin = user.username === 'admin' || (user.roleNames && user.roleNames.includes('Administrator'));

                if (isAdmin) {
                    document.getElementById('nav-admin-link').style.display = 'flex'; // æ˜¾ç¤ºç®¡ç†å…¥å£
                    document.getElementById('display-user-role').textContent = 'ç³»ç»Ÿç®¡ç†å‘˜';
                } else {
                    document.getElementById('nav-admin-link').style.display = 'none'; // éšè—ç®¡ç†å…¥å£
                    document.getElementById('display-user-role').textContent = 'æ™®é€šæ“ä½œå‘˜';
                }
            } catch (e) {
                console.error('ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥:', e);
                localStorage.clear();
                window.location.href = 'login.html';
            }
        }

        function handleLogout() {
            if(confirm('ç¡®å®šè¦é€€å‡ºç³»ç»Ÿå—ï¼Ÿ')) {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('current_user');
                window.location.href = 'login.html';
            }
        }

        // -----------------------------------
        // å›¾è¡¨åˆå§‹åŒ–é€»è¾‘
        // -----------------------------------

        // åˆå§‹åŒ–å·¦ä¾§é¥¼å›¾
        let statusChart = null;
        function initStatusChart() {
            const chartDom = document.getElementById('chart-status');
            statusChart = echarts.init(chartDom);
            const option = {
                // æç¤ºæ¡†
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c} ({d}%)'
                },
                // å›¾ä¾‹
                legend: {
                    bottom: '5%',
                    left: 'center',
                    textStyle: { color: '#8ba4c9' }
                },
                series: [{
                    name: 'è®¾å¤‡çŠ¶æ€',
                    type: 'pie',
                    radius: ['40%', '65%'], // ç¯å½¢å›¾
                    center: ['50%', '45%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 8,
                        borderColor: '#0a1e3d',
                        borderWidth: 2
                    },
                    label: {
                        show: false,
                        position: 'center'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 16,
                            fontWeight: 'bold',
                            color: '#fff'
                        }
                    },
                    labelLine: { show: false },
                    data: [
                        { value: 185, name: 'æ­£å¸¸è¿è¡Œ', itemStyle: { color: '#00c6ff' } },
                        { value: 12, name: 'é€šè®¯ä¸­æ–­', itemStyle: { color: '#faad14' } },
                        { value: 5, name: 'æ°´ä½æŠ¥è­¦', itemStyle: { color: '#ff4d4f' } }
                    ]
                }]
            };
            statusChart.setOption(option);
        }

        // [æ–°å¢] åˆå§‹åŒ–åŒ—äº¬åœ°å›¾å’Œé™é›¨æ•°æ®
        let mapChart = null;
        async function initBeijingMapChart() {
            const chartDom = document.getElementById('beijing-map-container');
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            mapChart = echarts.init(chartDom);
            mapChart.showLoading({
                text: 'æ­£åœ¨åŠ è½½åŒ—äº¬å¸‚åœ°å›¾æ•°æ®...',
                color: '#00c6ff',
                textColor: '#00c6ff',
                maskColor: 'rgba(10, 30, 61, 0.8)'
            });

            try {
                // 1. è·å–åŒ—äº¬å¸‚ GeoJSON æ•°æ® (ä½¿ç”¨é˜¿é‡Œäº‘ DataV çš„å…¬å¼€æ¥å£)
                // æ³¨æ„ï¼šå¦‚æœæ­¤æ¥å£ä¸ç¨³å®šï¼Œéœ€è¦ä¸‹è½½ geojson æ–‡ä»¶åˆ°æœ¬åœ°é¡¹ç›®å¹¶å¼•ç”¨
                const response = await fetch('https://geo.datav.aliyun.com/areas_v3/bound/110000_full.json');
                if (!response.ok) throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                const beijingGeoJson = await response.json();

                // 2. æ³¨å†Œåœ°å›¾
                echarts.registerMap('beijing', beijingGeoJson);

                // 3. éšè—åŠ è½½åŠ¨ç”»
                mapChart.hideLoading();

                // 4. ç”Ÿæˆæ¨¡æ‹Ÿçš„é™é›¨ç›‘æµ‹ç‚¹æ•°æ®
                // çœŸå®åœºæ™¯ä¸­ï¼Œè¿™äº›æ•°æ®åº”ä»åç«¯ API è·å–
                const mockRainData = [
                    { name: "æµ·æ·€åŒºç›‘æµ‹ç‚¹A", value: [116.29845, 39.95933, 120] }, // [ç»åº¦, çº¬åº¦, é™é›¨é‡mm]
                    { name: "æœé˜³åŒºç›‘æµ‹ç‚¹B", value: [116.49728, 39.91364, 85] },
                    { name: "ä¸°å°åŒºç›‘æµ‹ç‚¹C", value: [116.28696, 39.85850, 45] },
                    { name: "çŸ³æ™¯å±±åŒºç›‘æµ‹ç‚¹D", value: [116.18895, 39.90596, 150] },
                    { name: "é€šå·åŒºç›‘æµ‹ç‚¹E", value: [116.66385, 39.90966, 20] },
                    { name: "æ˜Œå¹³åŒºç›‘æµ‹ç‚¹F", value: [116.23128, 40.22063, 60] },
                    { name: "å¤§å…´åŒºç›‘æµ‹ç‚¹G", value: [116.34139, 39.72693, 10] },
                    { name: "é¡ºä¹‰åŒºç›‘æµ‹ç‚¹H", value: [116.65417, 40.13020, 35] },
                    { name: "è¥¿åŸåŒºç›‘æµ‹ç‚¹I", value: [116.36578, 39.91239, 95] },
                    { name: "ä¸œåŸåŒºç›‘æµ‹ç‚¹J", value: [116.41875, 39.91748, 70] },
                    { name: "å¯†äº‘åŒºç›‘æµ‹ç‚¹K", value: [116.84311, 40.37630, 5] },
                    { name: "å»¶åº†åŒºç›‘æµ‹ç‚¹L", value: [115.97497, 40.45673, 180] }, // ç‰¹å¤§æš´é›¨ç‚¹
                ];

                // 5. é…ç½®åœ°å›¾ Option
                const option = {
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: 'rgba(10, 30, 61, 0.9)',
                        borderColor: '#00c6ff',
                        textStyle: { color: '#fff' },
                        formatter: function (params) {
                            if (params.seriesType === 'effectScatter') {
                                return `${params.data.name}<br/>å½“å‰é™é›¨é‡: <b style="color:#ff4d4f; font-size:16px;">${params.data.value[2]} mm</b>`;
                            } else {
                                return params.name;
                            }
                        }
                    },
                    // åœ°ç†åæ ‡ç³»ç»„ä»¶
                    geo: {
                        map: 'beijing',
                        roam: true, // å¼€å¯é¼ æ ‡ç¼©æ”¾å’Œå¹³ç§»
                        zoom: 1.2, // åˆå§‹ç¼©æ”¾æ¯”ä¾‹
                        label: {
                            emphasis: {
                                show: true,
                                color: '#fff'
                            }
                        },
                        // åœ°å›¾åŒºåŸŸçš„å¤šè¾¹å½¢ å›¾å½¢æ ·å¼
                        itemStyle: {
                            normal: {
                                areaColor: 'rgba(13, 33, 68, 0.6)', // åœ°å›¾å¡«å……è‰²
                                borderColor: 'rgba(0, 198, 255, 0.4)', // è¾¹æ¡†é¢œè‰²
                                borderWidth: 1,
                                shadowColor: 'rgba(0, 198, 255, 0.5)',
                                shadowBlur: 10
                            },
                            emphasis: {
                                areaColor: '#0f375f' // é«˜äº®é¢œè‰²
                            }
                        }
                    },
                    // è§†è§‰æ˜ å°„ç»„ä»¶ï¼Œç”¨äºæ ¹æ®é™é›¨é‡æ•°å€¼æ˜¾ç¤ºä¸åŒé¢œè‰²
                    visualMap: {
                        type: 'piecewise', // åˆ†æ®µå‹
                        left: '20',
                        bottom: '20',
                        showLabel: true,
                        textStyle: { color: '#fff' },
                        pieces: [
                            { gte: 150, label: 'ç‰¹å¤§æš´é›¨ (>150mm)', color: '#ff4d4f' }, // çº¢è‰²
                            { gte: 100, lt: 150, label: 'å¤§æš´é›¨ (100-150mm)', color: '#ff7a45' }, // æ©™çº¢
                            { gte: 50, lt: 100, label: 'æš´é›¨ (50-100mm)', color: '#faad14' }, // é»„è‰²
                            { gte: 25, lt: 50, label: 'å¤§é›¨ (25-50mm)', color: '#13c2c2' }, // é’è‰²
                            { gte: 10, lt: 25, label: 'ä¸­é›¨ (10-25mm)', color: '#00c6ff' }, // è“è‰²
                            { lt: 10, label: 'å°é›¨ (<10mm)', color: '#8ba4c9' }  // æµ…è“
                        ],
                        dimension: 2 // æŒ‡å®šç”¨æ•°æ®ä¸­çš„ç¬¬ä¸‰ä¸ªç»´åº¦ï¼ˆå³é™é›¨é‡ï¼‰è¿›è¡Œæ˜ å°„
                    },
                    series: [
                        // å¸¦æœ‰æ¶Ÿæ¼ªç‰¹æ•ˆåŠ¨ç”»çš„æ•£ç‚¹å›¾
                        {
                            name: 'å®æ—¶é™é›¨ç›‘æµ‹',
                            type: 'effectScatter',
                            coordinateSystem: 'geo', // ä½¿ç”¨åœ°ç†åæ ‡ç³»
                            data: mockRainData,
                            symbolSize: function (val) {
                                // æ ¹æ®é™é›¨é‡å¤§å°åŠ¨æ€è°ƒæ•´æ•£ç‚¹å¤§å° (æœ€å°10, æœ€å¤§30)
                                return Math.max(10, Math.min(val[2] / 5, 30));
                            },
                            showEffectOn: 'render', // ç»˜åˆ¶å®Œæˆåæ˜¾ç¤ºç‰¹æ•ˆ
                            rippleEffect: {
                                brushType: 'stroke', // æ³¢çº¹ç»˜åˆ¶æ–¹å¼
                                scale: 3 // æ³¢çº¹æœ€å¤§ç¼©æ”¾æ¯”ä¾‹
                            },
                            label: {
                                formatter: '{b}',
                                position: 'right',
                                show: false // é»˜è®¤ä¸æ˜¾ç¤ºæ ‡ç­¾ï¼Œé¼ æ ‡ç§»ä¸Šå»æ˜¾ç¤º
                            },
                            itemStyle: {
                                shadowBlur: 10,
                                shadowColor: '#333'
                            },
                            emphasis: {
                                label: { show: true }
                            },
                            zlevel: 1
                        }
                    ]
                };
                mapChart.setOption(option);

            } catch (error) {
                console.error('åœ°å›¾åŠ è½½å¤±è´¥:', error);
                mapChart.hideLoading();
                chartDom.innerHTML = '<div style="color: #ff4d4f; text-align: center; padding-top: 100px;">åœ°å›¾æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚</div>';
            }
        }

        // -----------------------------------
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        // -----------------------------------
        window.addEventListener('DOMContentLoaded', () => {
            // 1. æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkAuth();
            // 2. åˆå§‹åŒ–é¥¼å›¾
            initStatusChart();
            // 3. åˆå§‹åŒ–åœ°å›¾ (å¼‚æ­¥)
            initBeijingMapChart();
        });

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œè‡ªé€‚åº”è°ƒæ•´å›¾è¡¨å¤§å°
        window.addEventListener('resize', () => {
            if (statusChart) statusChart.resize();
            if (mapChart) mapChart.resize();
        });
    </script>
</body>
</html>
