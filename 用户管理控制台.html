<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç®¡ç† | å¹¿åŸŸç«‹ä½“é£é™©æ„ŸçŸ¥å¹³å°</title>
    <!-- FIX: æ·»åŠ  Favicon é“¾æ¥ä»¥æ¶ˆé™¤ 404 é”™è¯¯ -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ›¡ï¸</text></svg>">
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* æ·±è‰²ä¸»é¢˜é…ç½®ï¼Œä¸PPTé£æ ¼ä¸€è‡´ */
        :root {
            --color-primary: #4f46e5;
            /* Indigo-600 */
            --color-background: #0f172a;
            /* Slate-900 */
            --color-card: #1e293b;
            /* Slate-800 */
            --color-text-light: #f1f5f9;
            /* Slate-100 */
            --color-text-muted: #94a3b8;
            /* Slate-400 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-light);
            min-height: 100vh;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        /* æ ‡ç­¾é¡µæ¿€æ´»æ ·å¼ */
        .tab-btn {
            padding: 0.75rem 1rem;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--color-text-muted);
        }

        .tab-btn:hover {
            color: var(--color-text-light);
        }

        .tab-btn.active {
            color: var(--color-primary);
            border-bottom: 3px solid var(--color-primary);
            font-weight: 600;
        }
    </style>
</head>

<body>

    <div id="app" class="p-4 md:p-8">

        <!-- æ ‡é¢˜åŒº -->
        <header class="mb-6 pb-4 border-b border-slate-700 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-slate-50 flex items-center">
                <i data-lucide="users" class="w-7 h-7 mr-3 text-indigo-400"></i>
                ç”¨æˆ·æƒé™ç®¡ç†ä¸­å¿ƒ
            </h1>
            <div class="flex items-center gap-4">
                <div class="text-sm text-slate-400 hidden md:block">
                    å¹³å°ç­‰çº§æƒé™é…ç½® (API/èœå•çº§)
                </div>
                <!-- è¿”å›ä¸»é¡µæŒ‰é’® -->
                <button onclick="window.location.href='home.html'"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 shadow-md flex items-center whitespace-nowrap">
                    <i data-lucide="home" class="w-4 h-4 mr-1"></i>
                    è¿”å›ä¸»é¡µ
                </button>
            </div>
        </header>

        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <nav class="flex space-x-6 border-b border-slate-700 mb-6">
            <button id="tab-users" class="tab-btn active" data-tab="users">ç”¨æˆ·åˆ—è¡¨</button>
            <button id="tab-roles" class="tab-btn" data-tab="roles">è§’è‰²ä¸æƒé™</button>
        </nav>

        <!-- å†…å®¹åŒºåŸŸ -->
        <div id="content">

            <!-- 1. ç”¨æˆ·åˆ—è¡¨ Tab -->
            <div id="tab-content-users" class="tab-content">
                <div class="bg-card p-6 rounded-xl shadow-lg border border-slate-700">

                    <!-- ç”¨æˆ·ç®¡ç†æ§åˆ¶å°.html ä¿®æ”¹éƒ¨åˆ† 1ï¼šæ·»åŠ æœç´¢æ¡†ç»“æ„ -->
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-xl font-semibold text-indigo-300">ç³»ç»Ÿç”¨æˆ·åˆ—è¡¨</h2>

                        <div class="flex gap-3 w-full md:w-auto">
                            <!-- æ–°å¢ï¼šæœç´¢æ¡† -->
                            <div class="relative flex-grow md:flex-grow-0">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400"></i>
                                </div>
                                <input type="text" id="user-search-input"
                                    class="bg-slate-700 border border-slate-600 text-slate-100 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-10 p-2.5 placeholder-slate-400"
                                    placeholder="æœç´¢ç”¨æˆ·åæˆ–å§“å...">
                            </div>

                            <!-- åŸæœ‰çš„æ–°å¢æŒ‰é’® -->
                            <button onclick="openUserModal('add')"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 shadow-md flex items-center whitespace-nowrap">
                                <i data-lucide="plus" class="w-4 h-4 mr-1"></i>
                                æ–°å¢ç”¨æˆ·
                            </button>
                        </div>
                    </div>


                    <!-- ç”¨æˆ·æ•°æ®è¡¨æ ¼ -->
                    <div class="overflow-x-auto rounded-lg border border-slate-700">
                        <table class="min-w-full divide-y divide-slate-700">
                            <thead class="bg-slate-700">
                                <tr>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
                                        ç”¨æˆ·ID</th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
                                        ç”¨æˆ·å</th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
                                        çœŸå®å§“å</th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
                                        è§’è‰²</th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
                                        çŠ¶æ€</th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
                                        æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body" class="divide-y divide-slate-800">
                                <!-- æ•°æ®å°†ç”±JSå¡«å…… -->
                            </tbody>
                        </table>
                    </div>

                    <p id="user-loading-message" class="text-center p-6 text-slate-400">åŠ è½½ä¸­...</p>
                </div>
            </div>

            <!-- 2. è§’è‰²ä¸æƒé™ Tab -->
            <div id="tab-content-roles" class="tab-content hidden">
                <div class="bg-card p-6 rounded-xl shadow-lg border border-slate-700">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-3">
                        <h2 class="text-xl font-semibold text-indigo-300">è§’è‰²æ¨¡æ¿é…ç½®</h2>
                        <button onclick="openRoleModal('add')"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 shadow-md flex items-center">
                            <i data-lucide="shield-plus" class="w-4 h-4 mr-1"></i>
                            æ–°å¢è§’è‰²
                        </button>
                    </div>

                    <!-- è§’è‰²åˆ—è¡¨ -->
                    <div id="role-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- è§’è‰²å¡ç‰‡å°†ç”±JSå¡«å…… -->
                    </div>
                    <p id="role-loading-message" class="text-center p-6 text-slate-400">åŠ è½½ä¸­...</p>
                </div>
            </div>

        </div>
    </div>

    <!-- å¼¹çª—ï¼šç”¨æˆ·æ·»åŠ /ç¼–è¾‘ Modal -->
    <div id="user-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 overflow-y-auto"
        onclick="closeModal(event, 'user-modal')">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-slate-800 w-full max-w-lg p-6 rounded-xl shadow-2xl border border-slate-700"
                onclick="event.stopPropagation()">
                <h3 id="user-modal-title" class="text-2xl font-bold mb-6 text-indigo-300">æ–°å¢ç”¨æˆ·</h3>
                <form id="user-form">
                    <input type="hidden" id="user-id">

                    <div class="mb-4">
                        <label for="username" class="block text-sm font-medium mb-1 text-slate-300">ç”¨æˆ·å</label>
                        <input type="text" id="username" required
                            class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-slate-50">
                    </div>

                    <div class="mb-4">
                        <label for="password" class="block text-sm font-medium mb-1 text-slate-300">å¯†ç 
                            (æ–°å¢/ä¿®æ”¹æ—¶å¡«å†™)</label>
                        <input type="password" id="password"
                            class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-slate-50">
                    </div>

                    <div class="mb-4">
                        <label for="real-name" class="block text-sm font-medium mb-1 text-slate-300">çœŸå®å§“å</label>
                        <input type="text" id="real-name"
                            class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-slate-50">
                    </div>

                    <div class="mb-4">
                        <label for="user-role-select" class="block text-sm font-medium mb-1 text-slate-300">åˆ†é…è§’è‰²</label>
                        <select id="user-role-select" multiple
                            class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-slate-50 h-32">
                            <!-- è§’è‰²é€‰é¡¹å°†ç”±JSå¡«å…… -->
                        </select>
                        <p class="text-xs text-slate-400 mt-1">æŒ‰ä½Ctrl/Cmdå¯å¤šé€‰</p>
                    </div>

                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="document.getElementById('user-modal').classList.add('hidden')"
                            class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition duration-200">å–æ¶ˆ</button>
                        <button type="submit"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-200">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šè§’è‰²æ·»åŠ /ç¼–è¾‘ Modal -->
    <div id="role-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 overflow-y-auto"
        onclick="closeModal(event, 'role-modal')">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-slate-800 w-full max-w-2xl p-6 rounded-xl shadow-2xl border border-slate-700"
                onclick="event.stopPropagation()">
                <h3 id="role-modal-title" class="text-2xl font-bold mb-6 text-indigo-300">æ–°å¢è§’è‰²</h3>
                <form id="role-form">
                    <input type="hidden" id="role-id">

                    <div class="mb-4">
                        <label for="role-name" class="block text-sm font-medium mb-1 text-slate-300">è§’è‰²åç§°</label>
                        <input type="text" id="role-name" required
                            class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-slate-50">
                    </div>

                    <div class="mb-4">
                        <label for="role-desc" class="block text-sm font-medium mb-1 text-slate-300">æè¿°</label>
                        <textarea id="role-desc"
                            class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-slate-50"></textarea>
                    </div>

                    <h4 class="text-lg font-medium mt-6 mb-3 text-slate-300">æƒé™é…ç½® (API/èœå•çº§)</h4>
                    <div id="permission-checkboxes"
                        class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-slate-700 p-4 rounded-lg max-h-80 overflow-y-auto">
                        <!-- æƒé™å¤é€‰æ¡†å°†ç”±JSå¡«å…… -->
                    </div>

                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="document.getElementById('role-modal').classList.add('hidden')"
                            class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition duration-200">å–æ¶ˆ</button>
                        <button type="submit"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-200">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Lucide Icons æ¸²æŸ“
        lucide.createIcons();

        // ---------------------------------------------
        // API é…ç½®
        // ---------------------------------------------
        const API_BASE_URL = 'http://localhost:3000/api';

        // å…¨å±€æ•°æ®ç¼“å­˜ï¼Œç”¨äºå‰ç«¯æ˜ å°„ (ä¾‹å¦‚ï¼šè§’è‰²IDåˆ°è§’è‰²åç§°)
        let globalRoles = [];
        let globalPermissions = [];

        // --- è¾…åŠ©å‡½æ•° ---

        /**
         * é€šç”¨APIè¯·æ±‚å‡½æ•°ï¼Œå¤„ç†JSONå’Œé”™è¯¯
         * @param {string} endpoint - API è·¯å¾„
         * @param {object} options - fetch é€‰é¡¹
         * @returns {Promise<object>} - API å“åº”æ•°æ®
         */
        async function apiFetch(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            try {
                const response = await fetch(url, {
                    headers: { 'Content-Type': 'application/json' },
                    ...options,
                });
                const data = await response.json();

                if (!response.ok) {
                    // å¦‚æœHTTPçŠ¶æ€ç ä¸æ˜¯2xxï¼ŒæŠ›å‡ºé”™è¯¯ä¿¡æ¯
                    throw new Error(data.message || `API Error: ${response.status}`);
                }
                return data;
            } catch (error) {
                console.error('API Error:', error);
                // ä½¿ç”¨è‡ªå®šä¹‰å¼¹çª—æ›¿ä»£ alert()
                showToast(`æ“ä½œå¤±è´¥: ${error.message || 'ç½‘ç»œè¿æ¥æˆ–æœåŠ¡å™¨é”™è¯¯'}`, 'error');
                throw error; // é‡æ–°æŠ›å‡ºé”™è¯¯ä»¥ä¾¿è°ƒç”¨æ–¹æ•è·
            }
        }

        function handleLogout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç®¡ç†ç³»ç»Ÿå—ï¼Ÿ')) {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('current_user');
                window.location.href = 'login.html';
            }
        }

        /**
         * è‡ªå®šä¹‰ Toast é€šçŸ¥ï¼ˆæ›¿ä»£ alert/confirmï¼‰
         */
        function showToast(message, type = 'info') {
            let toast = document.getElementById('api-toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'api-toast';
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px;
                    border-radius: 8px;
                    color: white;
                    font-weight: bold;
                    z-index: 1000;
                    transition: opacity 0.5s ease;
                    opacity: 0;
                    pointer-events: none; /* é˜²æ­¢é®æŒ¡ç‚¹å‡» */
                `;
                document.body.appendChild(toast);
            }

            const colors = {
                info: '#4f46e5',   // indigo-600
                success: '#059669', // green-600
                error: '#dc2626'    // red-600
            };

            // ä½¿ç”¨èƒŒæ™¯è‰²ï¼ˆé¿å…ä¾èµ– Tailwind classï¼‰
            toast.style.backgroundColor = colors[type] || colors.info;
            toast.textContent = message;

            // å¼ºåˆ¶é‡æ’ï¼Œç¡®ä¿ transition ç”Ÿæ•ˆ
            void toast.offsetWidth;

            // æ˜¾ç¤ºï¼ˆè§¦å‘åŠ¨ç”»ï¼‰
            toast.style.opacity = '1';

            // 3ç§’åå¼€å§‹æ·¡å‡ºï¼Œå¹¶åœ¨åŠ¨ç”»ç»“æŸåç§»é™¤
            setTimeout(() => {
                toast.style.opacity = '0';
                // ç­‰å¾…æ·¡å‡ºåŠ¨ç”»å®Œæˆï¼ˆ0.5sï¼‰åå†ç§»é™¤
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                        // æˆ–è€…ç”¨ï¼štoast.remove(); ï¼ˆç°ä»£æµè§ˆå™¨æ”¯æŒï¼‰
                    }
                }, 500); // ä¸ CSS transition æ—¶é—´ä¸€è‡´
            }, 2000
        }

        /**
         * åŠ è½½æ‰€æœ‰å…¨å±€æ•°æ®ï¼ˆè§’è‰²å’Œæƒé™ï¼‰ï¼Œç¡®ä¿æ•°æ®æ˜ å°„å¯ç”¨
         */
        async function loadGlobalData() {
            try {
                // æ³¨æ„ï¼šroles API è·¯ç”±å·²ç»åŒ…å«äº† permissionIds
                globalRoles = await apiFetch('/roles');
                globalPermissions = await apiFetch('/permissions');
            } catch (e) {
                console.error('Failed to load global data for roles/permissions:', e);
            }
        }

        // --- æ¸²æŸ“é€»è¾‘ ---

        /**
         * åˆ‡æ¢æ ‡ç­¾é¡µå†…å®¹
         * @param {string} tabName - users æˆ– roles
         */
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-tab') === tabName) {
                    btn.classList.add('active');
                }
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');

            // é‡æ–°åŠ è½½æ•°æ®
            if (tabName === 'users') {
                renderUserTable();
            } else if (tabName === 'roles') {
                renderRoleList();
            }
        }

        /**
         * æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨è¡¨æ ¼ (ä¿®æ”¹ç‰ˆï¼šæ”¯æŒæœç´¢)
         * @param {string} searchTerm - æœç´¢å…³é”®è¯ï¼Œé»˜è®¤ä¸ºç©º
         */
        async function renderUserTable(searchTerm = '') {
            const tableBody = document.getElementById('user-table-body');
            const loadingMessage = document.getElementById('user-loading-message');

            tableBody.innerHTML = '';
            loadingMessage.classList.remove('hidden');
            loadingMessage.textContent = 'åŠ è½½ä¸­...';

            try {
                await loadGlobalData();

                // --- æ ¸å¿ƒä¿®æ”¹ç‚¹ ---
                // æ„å»º API URLï¼Œå¦‚æœæœ‰æœç´¢è¯åˆ™å¸¦ä¸Šå‚æ•°
                let url = '/users';
                if (searchTerm) {
                    // encodeURIComponent ç”¨äºå¤„ç†ç‰¹æ®Šå­—ç¬¦ (å¦‚ç©ºæ ¼ã€ä¸­æ–‡)
                    url += `?search=${encodeURIComponent(searchTerm)}`;
                }

                const users = await apiFetch(url);
                // ------------------

                loadingMessage.classList.add('hidden');

                if (users.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-slate-400">
                    <div class="flex flex-col items-center">
                        <i data-lucide="search-x" class="w-8 h-8 mb-2 opacity-50"></i>
                        æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·
                    </div>
                 </td></tr>`;
                    lucide.createIcons(); // åˆ·æ–°å›¾æ ‡
                    return;
                }

                users.forEach(user => {
                    // ... è¿™é‡Œçš„ä»£ç ä¿æŒä¸å˜ï¼Œè´Ÿè´£æ¸²æŸ“æ¯ä¸€è¡Œ ...
                    // ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œçœç•¥é‡å¤çš„æ¸²æŸ“ä»£ç 
                    // è¯·ä¿ç•™æ‚¨åŸæœ‰çš„ users.forEach å†…éƒ¨é€»è¾‘
                    const userRoles = user.roleIds.map(id => globalRoles.find(r => r.id === id)?.role_name || 'æœªçŸ¥').join(', ');
                    const status = user.status;
                    const statusClass = status === 'active' ? 'text-green-400 bg-green-900' : 'text-red-400 bg-red-900';

                    const row = `
                    <tr class="hover:bg-slate-800 transition duration-150">
                        <td class="px-4 py-3 text-sm font-medium text-slate-300">${user.id}</td>
                        <td class="px-4 py-3 text-sm">${user.username}</td>
                        <td class="px-4 py-3 text-sm">${user.realName || '-'}</td>
                        <td class="px-4 py-3 text-sm text-indigo-400">${userRoles}</td>
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${statusClass} bg-opacity-50">
                                ${status === 'active' ? 'æ¿€æ´»' : 'ç¦ç”¨'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm whitespace-nowrap">
                            <button onclick="openUserModal('edit', ${user.id})" class="text-indigo-400 hover:text-indigo-300 mr-3">ç¼–è¾‘</button>
                            <button onclick="confirmToggleUserStatus(${user.id}, '${status}')" class="text-yellow-400 hover:text-yellow-300 mr-3">${status === 'active' ? 'ç¦ç”¨' : 'æ¿€æ´»'}</button>
                            <button onclick="confirmDeleteUser(${user.id})" class="text-red-400 hover:text-red-300">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
                lucide.createIcons();

            } catch (error) {
                loadingMessage.textContent = 'åŠ è½½å¤±è´¥';
            }
        }

        // --- æ–°å¢ï¼šç»‘å®šæœç´¢äº‹ä»¶ ---
        document.addEventListener('DOMContentLoaded', async () => {
            // ... åŸæœ‰çš„ä»£ç  ...

            const searchInput = document.getElementById('user-search-input');

            // 1. ç›‘å¬å›è½¦é”® (æŒ‰ä¸‹å›è½¦ç«‹å³æœç´¢)
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    renderUserTable(searchInput.value.trim());
                }
            });

            // 2. (å¯é€‰) ç›‘å¬è¾“å…¥å˜åŒ– (å®ç°å®æ—¶æœç´¢ï¼Œä¸ºäº†æ€§èƒ½å»ºè®®åŠ å»¶è¿Ÿï¼Œæˆ–è€…åªç”¨ä¸Šé¢çš„å›è½¦æœç´¢)
            // è¿™é‡Œæ¼”ç¤ºç®€å•çš„é˜²æŠ–é€»è¾‘ï¼šç”¨æˆ·åœæ­¢è¾“å…¥ 500ms åè‡ªåŠ¨æœç´¢
            let timeout = null;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    renderUserTable(searchInput.value.trim());
                }, 500);
            });
        });

        /**
         * æ¸²æŸ“è§’è‰²åˆ—è¡¨å¡ç‰‡
         */
        async function renderRoleList() {
            const roleListDiv = document.getElementById('role-list');
            const loadingMessage = document.getElementById('role-loading-message');

            roleListDiv.innerHTML = '';
            loadingMessage.classList.remove('hidden');

            try {
                await loadGlobalData(); // ç¡®ä¿æƒé™æ•°æ®å·²åŠ è½½
                const roles = globalRoles; // ä½¿ç”¨å…¨å±€ç¼“å­˜çš„ roles

                loadingMessage.classList.add('hidden');

                if (roles.length === 0) {
                    roleListDiv.innerHTML = `<p class="text-center py-4 text-slate-400 col-span-full">æš‚æ— è§’è‰²æ¨¡æ¿æ•°æ®</p>`;
                    return;
                }

                roles.forEach(role => {
                    const rolePermissions = role.permissionIds
                        .map(id => globalPermissions.find(p => p.id === id)?.permission_name || 'æœªçŸ¥')
                        .slice(0, 3);
                    const permissionText = rolePermissions.join('ã€') + (rolePermissions.length < role.permissionIds.length ? '...' : '');

                    const card = `
                    <div class="bg-slate-800 p-5 rounded-xl border border-slate-700 hover:border-indigo-500 transition duration-200">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="text-xl font-bold text-indigo-400">${role.role_name}</h4>
                            <div class="flex space-x-2">
                                <button onclick="openRoleModal('edit', ${role.id})" class="text-slate-400 hover:text-indigo-400">
                                    <i data-lucide="pencil" class="w-4 h-4"></i>
                                </button>
                                <button onclick="confirmDeleteRole(${role.id}, '${role.role_name}')" class="text-slate-400 hover:text-red-400">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-slate-400 mb-4">${role.description}</p>
                        <div class="text-xs text-slate-500">
                            <p class="font-medium text-slate-300 mb-1 flex items-center"><i data-lucide="shield" class="w-3 h-3 mr-1"></i> æƒé™ç¤ºä¾‹ (${role.permissionIds.length}é¡¹):</p>
                            <p class="ml-4">${permissionText || 'æ— æƒé™'}</p>
                        </div>
                    </div>
                `;
                    roleListDiv.insertAdjacentHTML('beforeend', card);
                });
                lucide.createIcons();
            } catch (error) {
                loadingMessage.textContent = 'åŠ è½½è§’è‰²æ•°æ®å¤±è´¥ã€‚è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œæ­£å¸¸ã€‚';
                loadingMessage.classList.remove('hidden');
            }
        }

        /**
         * æ¸²æŸ“æƒé™å¤é€‰æ¡†ä¾›è§’è‰²é…ç½®ä½¿ç”¨
         */
        function renderPermissionCheckboxes(selectedPermissionIds = []) {
            const container = document.getElementById('permission-checkboxes');
            container.innerHTML = '';

            const permissions = globalPermissions;

            if (permissions.length === 0) {
                container.innerHTML = `<p class="text-center p-3 text-slate-400">æƒé™æ•°æ®åŠ è½½å¤±è´¥æˆ–ä¸ºç©ºã€‚</p>`;
                return;
            }

            // æŒ‰æ¨¡å—åˆ†ç»„æƒé™
            const groupedPermissions = permissions.reduce((acc, p) => {
                if (!acc[p.module]) acc[p.module] = [];
                acc[p.module].push(p);
                return acc;
            }, {});

            for (const module in groupedPermissions) {
                const moduleHtml = `
                <div class="mb-4 p-3 bg-slate-800 rounded-lg border border-slate-700">
                    <h5 class="text-md font-semibold mb-2 text-indigo-400">${module}</h5>
                    ${groupedPermissions[module].map(p => `
                        <div class="flex items-center mb-1">
                            <input id="perm-${p.id}" type="checkbox" value="${p.id}" ${selectedPermissionIds.includes(p.id) ? 'checked' : ''}
                                class="w-4 h-4 text-indigo-600 bg-slate-700 border-slate-600 rounded focus:ring-indigo-500">
                            <label for="perm-${p.id}" class="ml-2 text-sm font-medium text-slate-300">${p.permission_name} (${p.permission_key})</label>
                        </div>
                    `).join('')}
                </div>
            `;
                container.insertAdjacentHTML('beforeend', moduleHtml);
            }
        }

        // --- ç”¨æˆ·ç®¡ç† (CRUD) ---

        /**
         * æ‰“å¼€ç”¨æˆ·æ·»åŠ /ç¼–è¾‘å¼¹çª—
         * @param {string} mode - 'add' or 'edit'
         * @param {number} [userId] - ç”¨æˆ·ID
         */
        async function openUserModal(mode, userId) {
            await loadGlobalData(); // ç¡®ä¿è§’è‰²æ•°æ®æœ€æ–°
            const modal = document.getElementById('user-modal');
            const title = document.getElementById('user-modal-title');
            const form = document.getElementById('user-form');
            const roleSelect = document.getElementById('user-role-select');

            // æ¸²æŸ“è§’è‰²ä¸‹æ‹‰æ¡†
            roleSelect.innerHTML = globalRoles.map(r =>
                `<option value="${r.id}">${r.role_name} (${r.description})</option>`
            ).join('');

            form.reset();
            document.getElementById('user-id').value = '';

            if (mode === 'add') {
                title.textContent = 'æ–°å¢ç”¨æˆ·';
                document.getElementById('password').setAttribute('required', 'required');
            } else {
                title.textContent = 'ç¼–è¾‘ç”¨æˆ·';
                document.getElementById('password').removeAttribute('required');

                // æ¨¡æ‹Ÿè·å–å•ä¸ªç”¨æˆ·ä¿¡æ¯ï¼Œå®é™…åº”ç”¨ä¸­åº”è¯¥è°ƒç”¨ GET /api/users/{id}
                const allUsers = await apiFetch('/users');
                const user = allUsers.find(u => u.id === userId);

                if (user) {
                    document.getElementById('user-id').value = user.id;
                    document.getElementById('username').value = user.username;
                    document.getElementById('real-name').value = user.realName;

                    // é€‰ä¸­å·²åˆ†é…çš„è§’è‰²
                    Array.from(roleSelect.options).forEach(option => {
                        option.selected = user.roleIds.includes(parseInt(option.value));
                    });
                } else {
                    showToast('æ— æ³•åŠ è½½ç”¨æˆ·ä¿¡æ¯', 'error');
                    return;
                }
            }
            modal.classList.remove('hidden');
        }

        /**
         * å¤„ç†ç”¨æˆ·è¡¨å•æäº¤ (æ–°å¢/ç¼–è¾‘)
         */
        document.getElementById('user-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const userId = document.getElementById('user-id').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const realName = document.getElementById('real-name').value;

            const roleSelect = document.getElementById('user-role-select');
            const roleIds = Array.from(roleSelect.options)
                .filter(option => option.selected)
                .map(option => parseInt(option.value));

            const userData = {
                username,
                password,
                realName,
                roleIds
            };

            // ç§»é™¤ç©ºå¯†ç å­—æ®µï¼Œé¿å…ä¸å¿…è¦çš„æ›´æ–°
            if (!password) {
                delete userData.password;
            }

            try {
                    if (userId) {
                        await apiFetch(`/users/${userId}`, {
                            method: 'PUT',
                            body: JSON.stringify(userData)
                        });
                        showToast('ç”¨æˆ·æ›´æ–°æˆåŠŸ', 'success');
                    } else {
                        await apiFetch('/users', {
                            method: 'POST',
                            body: JSON.stringify(userData)
                        });
                        showToast('ç”¨æˆ·åˆ›å»ºæˆåŠŸ', 'success');
                    }
                } catch (error) {
                    // è¿™é‡Œçš„é”™è¯¯ä¼šè¢« apiFetch æ•è·å¹¶æç¤º
                    console.error("æäº¤å¤±è´¥:", error);
                } finally {
                    // ã€å…³é”®ä¿®æ”¹ã€‘æ— è®ºæˆåŠŸè¿˜æ˜¯æŠ¥é”™ï¼Œéƒ½å¿…é¡»æ‰§è¡Œä»¥ä¸‹ä»£ç 
                    const userModal = document.getElementById('user-modal');
                    if (userModal) {
                        userModal.classList.add('hidden'); // å½»åº•éšè—å¼¹çª—å’Œé®ç½©
                    }
                    renderUserTable(); // åˆ·æ–°è¡¨æ ¼
                    // æ¢å¤èº«ä½“æ»šåŠ¨ï¼ˆé˜²æ­¢å¼¹çª—é”å®šé¡µé¢ï¼‰
                    document.body.style.overflow = 'auto';
                }
        });

        /**
         * ç¡®è®¤å¹¶åˆ‡æ¢ç”¨æˆ·çŠ¶æ€ (æ¿€æ´»/ç¦ç”¨)
         */
        function confirmToggleUserStatus(userId, currentStatus) {
            const action = currentStatus === 'active' ? 'ç¦ç”¨' : 'æ¿€æ´»';
            const message = `ç¡®å®šè¦${action}ç”¨æˆ·ID ${userId} å—ï¼Ÿ`;

            // å®é™…é¡¹ç›®ä¸­åº”ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ€æ¡†
            if (window.confirm(message)) {
                toggleUserStatus(userId, currentStatus);
            }
        }

        async function toggleUserStatus(userId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            try {
                await apiFetch(`/users/${userId}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: newStatus })
                });
                showToast(`ç”¨æˆ·çŠ¶æ€å·²æ›´æ–°ä¸º ${newStatus === 'active' ? 'æ¿€æ´»' : 'ç¦ç”¨'}`, 'success');
            } catch (error) {
                console.error("çŠ¶æ€åˆ‡æ¢å¤±è´¥:", error);
                // è¿™é‡Œä¸éœ€è¦é¢å¤–å¤„ç†ï¼ŒapiFetch å†…éƒ¨é€šå¸¸å·²æœ‰æç¤º
            } finally {
                    // ã€å…³é”®ä¿®æ”¹ã€‘æ— è®ºæˆåŠŸè¿˜æ˜¯æŠ¥é”™ï¼Œéƒ½å¿…é¡»æ‰§è¡Œä»¥ä¸‹ä»£ç 
                    const userModal = document.getElementById('user-modal');
                    if (userModal) {
                        userModal.classList.add('hidden'); // å½»åº•éšè—å¼¹çª—å’Œé®ç½©
                    }
                    renderUserTable(); // åˆ·æ–°è¡¨æ ¼
                    // æ¢å¤èº«ä½“æ»šåŠ¨ï¼ˆé˜²æ­¢å¼¹çª—é”å®šé¡µé¢ï¼‰
                    document.body.style.overflow = 'auto';
                }
        }

        /**
         * ç¡®è®¤å¹¶åˆ é™¤ç”¨æˆ·
         */
        function confirmDeleteUser(userId) {
            // å®é™…é¡¹ç›®ä¸­åº”ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ€æ¡†
            if (window.confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ·ID ${userId} å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`)) {
                deleteUser(userId);
            }
        }

        async function deleteUser(userId) {
            try {
                await apiFetch(`/users/${userId}`, {
                    method: 'DELETE'
                });
                showToast('ç”¨æˆ·åˆ é™¤æˆåŠŸ', 'success');
                renderUserTable();
            } catch (error) {
                // é”™è¯¯å·²å¤„ç†
            }
        }

        // --- è§’è‰²ç®¡ç† (CRUD) ---

        /**
         * æ‰“å¼€è§’è‰²æ·»åŠ /ç¼–è¾‘å¼¹çª—
         */
        async function openRoleModal(mode, roleId) {
            await loadGlobalData(); // ç¡®ä¿æƒé™æ•°æ®æœ€æ–°
            const modal = document.getElementById('role-modal');
            const title = document.getElementById('role-modal-title');
            const form = document.getElementById('role-form');

            form.reset();
            document.getElementById('role-id').value = '';

            let selectedPermissions = [];

            if (mode === 'add') {
                title.textContent = 'æ–°å¢è§’è‰²æ¨¡æ¿';
            } else {
                title.textContent = 'ç¼–è¾‘è§’è‰²æ¨¡æ¿';
                const role = globalRoles.find(r => r.id === roleId);
                if (role) {
                    document.getElementById('role-id').value = role.id;
                    document.getElementById('role-name').value = role.role_name;
                    document.getElementById('role-desc').value = role.description;
                    selectedPermissions = role.permissionIds;
                }
            }

            renderPermissionCheckboxes(selectedPermissions);
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        /**
         * å¤„ç†è§’è‰²è¡¨å•æäº¤ (æ–°å¢/ç¼–è¾‘)
         */
        document.getElementById('role-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const roleId = document.getElementById('role-id').value;
            const role_name = document.getElementById('role-name').value;
            const description = document.getElementById('role-desc').value;

            const permissionIds = Array.from(document.querySelectorAll('#permission-checkboxes input[type="checkbox"]:checked'))
                .map(checkbox => parseInt(checkbox.value));

            const roleData = { role_name, description, permissionIds };

            try {
                if (roleId) {
                    // ç¼–è¾‘è§’è‰² (PUT /api/roles/:id)
                    await apiFetch(`/roles/${roleId}`, {
                        method: 'PUT',
                        body: JSON.stringify(roleData)
                    });
                    showToast('è§’è‰²æ›´æ–°æˆåŠŸ', 'success');
                } else {
                    // æ–°å¢è§’è‰² (POST /api/roles)
                    await apiFetch('/roles', {
                        method: 'POST',
                        body: JSON.stringify(roleData)
                    });
                    showToast('è§’è‰²åˆ›å»ºæˆåŠŸ', 'success');
                }

                document.getElementById('role-modal').classList.add('hidden');
                renderRoleList(); // é‡æ–°åŠ è½½æ•°æ®
            } catch (error) {
                // é”™è¯¯å·²åœ¨ apiFetch ä¸­å¤„ç†
            }
        });

        /**
         * ç¡®è®¤å¹¶åˆ é™¤è§’è‰²
         */
        function confirmDeleteRole(roleId, roleName) {
            // å®é™…é¡¹ç›®ä¸­åº”ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ€æ¡†
            if (window.confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰² [${roleName}] å—ï¼Ÿåˆ é™¤åï¼Œåˆ†é…ç»™è¯¥è§’è‰²çš„ç”¨æˆ·å°†å¤±å»ç›¸åº”æƒé™ï¼`)) {
                deleteRole(roleId);
            }
        }

        async function deleteRole(roleId) {
            try {
                await apiFetch(`/roles/${roleId}`, {
                    method: 'DELETE'
                });
                showToast('è§’è‰²åˆ é™¤æˆåŠŸ', 'success');
                renderRoleList();
                renderUserTable(); // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨ä»¥æ›´æ–°è§’è‰²æ˜¾ç¤º
            } catch (error) {
                // é”™è¯¯å·²å¤„ç†
            }
        }


        /**
         * é€šç”¨å…³é—­å¼¹çª—å‡½æ•°ï¼Œé¿å…ç‚¹å‡»å†…éƒ¨å…ƒç´ å…³é—­
         */
        function closeModal(event, modalId) {
            if (event.target.id === modalId) {
                document.getElementById(modalId).classList.add('hidden');
            }
        }

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', async () => {
            // ç»‘å®šæ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.getAttribute('data-tab')));
            });

            // é¢„å…ˆåŠ è½½ä¸€æ¬¡å…¨å±€æ•°æ®
            await loadGlobalData();

            // é»˜è®¤æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
            switchTab('users');
        });

    </script>

</body>

</html>